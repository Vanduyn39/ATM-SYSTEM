<div th:fragment="customerTable" class="container-fluid">

    <!-- Page Heading -->
    <h1 class="h3 mb-2 text-gray-800">Kh√°ch h√†ng</h1>


    <!-- DataTales Example -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Danh s√°ch kh√°ch h√†ng</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>H·ªç t√™n</th>
                        <th>SƒêT</th>
                        <th>Email</th>
                        <th>Thao t√°c</th>
                    </tr>
                    </thead>
                    <tfoot>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Thao t√°c</th>
                    </tr>
                    </tfoot>
                    <tbody>

                    <tr th:each="customer : ${customers}">
                        <td th:text="${customer.userId}">1</td>
                        <td th:text="${customer.name}"></td>
                        <td th:text="${customer.phone}"></td>
                        <td th:text="${customer.email}"></td>
                        <td>
                            <button class="btn btn-info" th:attr="onclick='viewTransactionHistory(' + ${customer.userId} + ')'" >
                                üïê L·ªãch s·ª≠ GD
                            </button>

                            <button class="btn btn-success" th:attr="onclick='viewDepositMoney(' + ${customer.userId} + ')'" >
                                üí≥ N·∫°p ti·ªÅn
                            </button>

                            <button class="btn btn-success" th:attr="onclick='viewInfoModal(' + ${customer.userId} + ')'" >
                                üìù C·∫≠p nh·∫≠t TT
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="transactionHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">L·ªãch s·ª≠ giao d·ªãch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-striped table-bordered" >
                    <thead class="table-dark">
                    <tr>
                        <th>Th·ªùi gian</th>
                        <th>S·ªë t√†i kho·∫£n</th>
                        <th>Kho·∫£n ti·ªÅn</th>
                        <th>Lo·∫°i</th>
                    </tr>
                    </thead>
                    <tbody id="transactionTable">

                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="depositModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">N·∫°p ti·ªÅn v√†o t√†i kho·∫£n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="depositForm">
                    <div class="mb-3">
                        <label class="form-label">Kh√°ch h√†ng: <span id="customerName"></span></label>

                    </div>
                    <div class="mb-3">
                        <label for="accountSelect" class="form-label">Ch·ªçn t√†i kho·∫£n:</label>
                        <select class="form-select" id="accountSelect">

                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="depositAmount" class="form-label">S·ªë ti·ªÅn c·∫ßn n·∫°p:</label>
                        <input type="number" class="form-control" id="depositAmount" placeholder="Nh·∫≠p s·ªë ti·ªÅn" required>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" id="depositButton" onclick="DepositMoney()">N·∫°p </button>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const depositModal = new bootstrap.Modal(document.getElementById("depositModal"));
    function viewTransactionHistory(customerId) {
        fetch('/api/transactions/get-user-transaction/' + customerId)
            .then(response => response.json())
            .then(data => {

                console.log(data)
                if (data.data == null){
                    alert("Kh√¥ng t√¨m th·∫•y l·ªãch s·ª≠ giao d·ªãch n√†o cho t√†i kho·∫£n n√†y")
                    return;
                }

                const dataTable = document.getElementById("transactionTable");
                const transactionList = sortByCreatedAt(data.data)
                dataTable.innerHTML = ""
                transactionList.forEach(transaction => {

                    const row = document.createElement("tr");

                    // T·∫°o c√°c √¥ d·ªØ li·ªáu
                    const timeCell = document.createElement("td");
                    timeCell.textContent = formatDateTime(transaction.createAt);

                    const accountCell = document.createElement("td");
                    accountCell.textContent = transaction.accountNumber;

                    const amountCell = document.createElement("td");
                    amountCell.textContent = formatCurrency(transaction.amount);

                    const typeCell = document.createElement("td");
                    typeCell.textContent = transaction.type;

                    // Th√™m c√°c √¥ v√†o d√≤ng
                    row.appendChild(timeCell);
                    row.appendChild(accountCell);
                    row.appendChild(amountCell);
                    row.appendChild(typeCell);

                    // Th√™m d√≤ng v√†o tbody
                    dataTable.appendChild(row);


                });
                new bootstrap.Modal(document.getElementById("transactionHistoryModal")).show();
            });

    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }
    function formatDateTime(dateTimeString) {

        const date = new Date(dateTimeString);


        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');


        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Th√°ng b·∫Øt ƒë·∫ßu t·ª´ 0
        const year = date.getFullYear();


        return `${hours}:${minutes}:${seconds} ${day}/${month}/${year}`;
    }

    // V√≠ d·ª• s·ª≠ d·ª•ng
    const formattedTime = formatDateTime("2025-04-01T16:27:37.000+00:00");
    console.log(formattedTime); // Output: 16:27:37 01/04/2025



    function viewDepositMoney(customerId) {
        fetch('/accounts/get-by-user/' + customerId)
            .then(response => response.json())
            .then(data => {

                console.log(data)
                if (data.data == null){
                    alert("Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n n√†o c·ªßa user n√†y")
                    return;
                }
                document.getElementById("customerName").innerHTML = customerId
                const accSelectEle = document.getElementById("accountSelect");
                accSelectEle.innerHTML =""
                data.data.forEach(acc =>{
                    const option = document.createElement("option");
                    option.value=acc.accountNumber;
                    option.text = acc.accountNumber;

                    accSelectEle.appendChild(option);
                })

                depositModal.show()
            });
    }

    function DepositMoney () {
        const account = document.getElementById('accountSelect').value;
        const amount = document.getElementById('depositAmount').value;
        const userId = document.getElementById("customerName").innerHTML;
        if (!amount || amount <= 0) {
            alert('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá!');
            return;
        }

        const payload = { account, amount };


        fetch('/api/transactions/admin-deposit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(response => response.json())
            .then(data => {
                alert(`K·∫øt qu·∫£: ${data.message}`);
                document.getElementById('depositAmount').value = ""
                depositModal.hide()
            })
            .catch(error => {
                console.error('C√≥ l·ªói x·∫£y ra:', error);
                alert('Giao d·ªãch th·∫•t b·∫°i!');
            });
    }

    function sortByCreatedAt(data) {
        return data.sort((a, b) => new Date(a.createAt) - new Date(b.createAt));
    }


</script>