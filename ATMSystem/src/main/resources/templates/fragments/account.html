<div th:fragment="accountTable" class="container-fluid">

    <!-- Page Heading -->
    <h1 class="h3 mb-2 text-gray-800">T√†i kho·∫£n</h1>
    <button class="btn btn-primary" style="margin-bottom: 1rem" onclick="viewNewAccModal()">
        T·∫°o m·ªõi
    </button>

    <!-- DataTales Example -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Danh s√°ch t√†i kho·∫£n</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                    <thead>

                    <tr>
                        <th>STK</th>
                        <th>Lo·∫°i TK</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>C·∫≠p nh·∫≠t l·∫ßn cu·ªëi</th>
                        <th>Thao t√°c</th>
                    </tr>
                    </thead>
                    <tfoot>
                    <tr>
                        <th>STK</th>
                        <th>Lo·∫°i TK</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>C·∫≠p nh·∫≠t l·∫ßn cu·ªëi</th>
                        <th>Thao t√°c</th>
                    </tr>
                    </tfoot>
                    <tbody>

                    <tr th:each="account : ${accounts}">
                        <td th:text="${account.accountNumber}"></td>
                        <td th:text="${account.accountType}"></td>
                        <td th:text="${account.status}"></td>
                        <td th:text="${account.lastUpdated}"></td>
                        <td>
                            <button class="btn btn-light" th:attr="onclick='viewPinModal(' + ${account.accountNumber} + ')'" >
                                üîë ƒê·ªïi PIN
                            </button>

                            <button class="btn btn-light" th:attr="onclick='viewStatusModal(' + ${account.accountNumber} + ')'" >
                                ‚úÖ ƒê·ªïi tr·∫°ng th√°i
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>


<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tr·∫°ng th√°i t√†i kho·∫£n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusForm">
                    <div class="mb-3">
                        <label class="form-label">T√†i kho·∫£n: <span id="pinID"></span></label>

                    </div>
                    <div class="mb-3">
                        <label for="accountStatus" class="form-label">Tr·∫°ng th√°i m·ªõi:</label>
                        <select name="accountStatus" id="accountStatus" class="form-select">
                            <option value="ACTIVE">ACTIVE</option>
                            <option value="CLOSED">CLOSED</option>
                            <option value="FROZEN">FROZEN</option>
                            <option value="BLOCKED">BLOCKED</option>
                            <option value="PENDING">PENDING</option>
                        </select>

                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" id="depositButton" onclick="changeStatus()">ƒê·ªïi</button>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="pinModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tr·∫°ng th√°i t√†i kho·∫£n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="pinForm">
                    <div class="mb-3">
                        <label class="form-label">T√†i kho·∫£n: <span id="pinIDModal"></span></label>
                    </div>

                    <div class="mb-3">
                        <label for="newPIN" class="form-label">PIN m·ªõi</label>
                        <input type="password" class="form-control" id="newPIN" placeholder="Nh·∫≠p PIN m·ªõi" required>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="changePIN()">C·∫≠p nh·∫≠t </button>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Th√™m t√†i kho·∫£n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addNewForm">
                    <!-- Account Number -->
                    <div class="mb-3">
                        <label for="accountNumber" class="form-label">Account Number</label>
                        <input type="text" class="form-control" id="accountNumber" name="accountNumber">
                    </div>
                    <!-- Full Name -->
                    <div class="mb-3">
                        <label for="fullName" class="form-label">H·ªç t√™n KH</label>
                        <input type="text" class="form-control" id="fullName" name="fullName">
                    </div>
                    <!-- User ID -->
                    <div class="mb-3">
                        <label for="userId" class="form-label">CCCD</label>
                        <input type="text" class="form-control" id="userId" name="userId">
                    </div>
                    <!-- Account Type -->
                    <div class="mb-3">
                        <label for="accountType" class="form-label">Account Type</label>
                        <select class="form-control" id="accountType">
                            <option value="SAVINGS">Ti·∫øt ki·ªám</option>
                            <option value="CHECKING">Thanh to√°n</option>
                        </select>
                    </div>
                    <!-- PIN -->
                    <div class="mb-3">
                        <label for="pin" class="form-label">PIN</label>
                        <input type="password" class="form-control" id="pin" name="pin">
                    </div>
                    <!-- Role -->
                    <div class="mb-3">
                        <label for="role" class="form-label">Role</label>
                        <input type="text" class="form-control" id="role" name="role" readonly value="USER">
                    </div>
                    <!-- Phone -->
                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="phone" name="phone">
                    </div>
                    <!-- Email -->
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email">
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="addNew()">T·∫°o </button>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const statusModal = new bootstrap.Modal(document.getElementById("statusModal"));
    const pinModal = new bootstrap.Modal(document.getElementById("pinModal"));
    const addModal = new bootstrap.Modal(document.getElementById("addModal"));

    function viewPinModal(accID) {

        document.getElementById("pinIDModal").innerHTML = accID
        pinModal.show()

    }

    function viewStatusModal(customerId) {
        document.getElementById("pinID").innerHTML = customerId
        statusModal.show()
    }

    function viewNewAccModal() {
        addModal.show()
    }

    function formatDateTime(dateTimeString) {

        const date = new Date(dateTimeString);


        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');


        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Th√°ng b·∫Øt ƒë·∫ßu t·ª´ 0
        const year = date.getFullYear();


        return `${hours}:${minutes}:${seconds} ${day}/${month}/${year}`;
    }

    function addNew(){

        const formData = {
            accountNumber: document.getElementById('accountNumber').value,
            fullName: document.getElementById('fullName').value,
            userId: document.getElementById('userId').value,
            accountType: document.getElementById('accountType').value,
            // status: null,
            // balance: null,
            pin: document.getElementById('pin').value,
            role: document.getElementById('role').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value,
        };


        // Ki·ªÉm tra d·ªØ li·ªáu h·ª£p l·ªá
        const errors = [];

        if (!formData.accountNumber) errors.push("Account Number kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
        if (!formData.fullName) errors.push("Full Name kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
        if (!formData.userId) errors.push("User ID kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
        if (!formData.accountType) errors.push("Account Type kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
        if (!formData.role) errors.push("Role kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
        if (!formData.phone || !/^\d{10,15}$/.test(formData.phone)) errors.push("Phone ph·∫£i l√† s·ªë t·ª´ 10 ƒë·∫øn 15 ch·ªØ s·ªë.");
        if (!formData.email || !/\S+@\S+\.\S+/.test(formData.email)) errors.push("Email kh√¥ng h·ª£p l·ªá.");

        // N·∫øu c√≥ l·ªói, hi·ªÉn th·ªã th√¥ng b√°o v√† d·ª´ng x·ª≠ l√Ω
        if (errors.length > 0) {
            alert("C√≥ l·ªói trong d·ªØ li·ªáu:\n" + errors.join("\n"));
            return;
        }



        fetch('/accounts/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
            .then(response => {
                // Ki·ªÉm tra n·∫øu response tr·∫£ v·ªÅ th√†nh c√¥ng
                if (response.ok) {
                    addModal.hide()
                    location.reload()
                    return// Parse response th√†nh JSON
                } else {
                    throw new Error('Response kh√¥ng th√†nh c√¥ng: ' + response.status);
                }
            })
            .catch(error => {
                console.error('C√≥ l·ªói x·∫£y ra:', error);
                alert('C√≥ l·ªói x·∫£y ra!');
            });
    }

    function changePIN(){

        const formData = {
            accountNumber: document.getElementById("pinIDModal").innerHTML,
            pin: document.getElementById('newPIN').value
        };


        fetch('/accounts/update', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
            .then(response => {
                if (response.ok){
                    alert("C·∫≠p nh·∫≠t th√†nh c√¥ng")
                    document.getElementById('newPIN').value = ""
                    pinModal.hide()
                }else alert('C√≥ l·ªói x·∫£y ra!');
            })
            .catch(error => {
                console.error('C√≥ l·ªói x·∫£y ra:', error);
                alert('C√≥ l·ªói x·∫£y ra!');
            });
    }

    function changeStatus(){

        const formData = {
            accountNumber: document.getElementById("pinID").innerHTML,
            status: document.getElementById('accountStatus').value
        };


        fetch('/accounts/update', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
            .then(response => {
                if (response.ok){
                    alert("C·∫≠p nh·∫≠t th√†nh c√¥ng")
                    pinModal.hide()
                    location.reload()
                }
            })
            .catch(error => {
                console.error('C√≥ l·ªói x·∫£y ra:', error);
                alert('C√≥ l·ªói x·∫£y ra!');
            });
    }

</script>